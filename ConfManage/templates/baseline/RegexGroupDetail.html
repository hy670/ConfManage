{% extends 'index.html' %}
{% block ace-content %}
    <script type="text/javascript" src="/static/dist/js/bootstrap-notify.js"></script>
{% endblock %}
{% block page-content %}
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header"><i class="fa   fa-dashboard"></i>合规策略</h1>
            </div>
        </div>
        <!--    策略组 -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-database"></i>基线策略组详细信息

                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">

                        <legend>基本信息</legend>
                        <h4>名称 ：{{ group.group_name }}</h4>
                        <h4>类型 ：{{ group.type }}</h4>
                        <h4>描述 ：{{ group.group_name }}</h4>
                        <br>
                        <legend>规则列表</legend>
                        <table width="100%" class="table table-striped table-bordered table-hover" id="assetsListTable">
                            <thead>
                            <tr>
                                <th class="text-center">名称</th>
                                <th class="text-center">描述</th>
                                <th class="text-center">违规级别</th>
                                <th class="text-center">检查类型</th>
                                <th class="text-center">测试</th>
                            </tr>
                            </thead>

                            <tbody>
                            {% for rule in  rulelist %}
                                <tr>
                                    <td class="text-center">
                                        <a  herf="#" onclick="RegexManageDetail({{ rule.rule_id }})"
                                           style="text-decoration:none;">{{ rule.rule_name }}</a>
                                    </td>
                                    <td class="text-center">{{ rule.rule_des }}</td>
                                    <td class="text-center">
                                        {% if rule.rule_severity == 0 %}
                                            通知
                                        {% elif  rule.rule_severity == 1 %}
                                            警告
                                        {% elif  rule.rule_severity == 2 %}
                                            次要
                                        {% elif  rule.rule_severity == 3 %}
                                            重要
                                        {% elif  rule.rule_severity == 4 %}
                                            紧急
                                        {% else  %}
                                            未定义
                                        {% endif %}
                                       </td>
                                    <td class="text-center">
                                       {% if rule.check_type == 0 %}
                                        设备
                                        {% elif rule.check_type == 1 %}
                                        接口
                                        {% elif rule.check_type == 2 %}
                                        配置
                                        {% else  %}
                                            未定义
                                        {% endif %}

                                    </td>

                                    <td class="text-center">
                                        <a href="/assets_mod/{{ rule.id }}" style="text-decoration:none;">
                                            <button type="button" class="btn btn-default"><abbr title="修改资料"><i
                                                    class="glyphicon glyphicon-edit"></i></abbr></button>
                                        </a>
                                    </td>

                                </tr>
                            {% endfor %}
                            </tbody>

                        </table>
                        <!-- /.table-responsive -->
                        <div class="well">
                            <h4>设备资产更新说明</h4>
                            <ol>
                                <li><p>点击<i class="glyphicon glyphicon-info-sign"></i>查看设备资产明细</li>
                                <li><p>点击<i class="glyphicon glyphicon-refresh"></i>更新设备信息</p></li>
                                <li><p>点击<i class="glyphicon glyphicon-edit"></i>编辑设备信息</p></li>
                                <li><p>点击<i class="glyphicon glyphicon-trash"></i>删除设备信息</p></li>
                            </ol>


                            <a class="btn btn-default btn-lg btn-block" target="_blank" href="/assets_add"><i
                                    class="fa fa-plus-circle "></i>新增资产</a>
                        </div>
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
        </div>
        <div class="modal fade" id="myAssetsImportModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Excel文件批量导入资产</h4>
                    </div>
                    <form role="form" method="post"
                          accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                          enctype="multipart/form-data" action='/assets_import/'
                          class="main form-horizontal">{% csrf_token %}
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">上传文件</label>
                                <div class="col-sm-6">
                                    <input type="file" name="import_file" placeholder="上传excel文件" required/>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="submit" class="btn btn-primary">导入</button>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>

        <div class="modal fade " id="RegexManageDetail" tabindex="-1" role="dialog" aria-labelledby="RegexManageAdd"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    </button>
                    <h4 class="modal-title" id="RegexManageAdd">
                        规则信息
                    </h4>
                </div>
                <div class="modal-body">
                    <h5>基本信息</h5>
                    <form class="form-horizontal" role="form" id="rule">
                        <!-- 名称 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>名称</strong></label>
                            <div class="col-sm-6">
                                <label class="control-label" type="text" id="rule_name"/>
                            </div>
                        </div>
                        <!-- 违规级别 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>违规级别</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="rule_severity" disabled="disabled">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="0" name="type">通知</option>
                                    <option value="1" name="type">警告</option>
                                    <option value="2" name="type">次要</option>
                                    <option value="3" name="type">重要</option>
                                    <option value="4" name="type">紧急</option>
                                </select>

                            </div>
                        </div>
                        <!-- 检查类型 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>检查类型</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="check_type" disabled="disabled">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="0" name="type">设备</option>
                                    <option value="1" name="type">接口</option>
                                    <option value="2" name="type">配置</option>
                                </select>
                            </div>
                        </div>
                        <!-- 开始标识 -->
                        <div class="form-group" id="check_content_start_div" style="display:none;">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>开始标识</strong></label>
                            <div class="col-sm-6">
                                 <textarea type="text" class="form-control" id="check_content_start"
                                           placeholder="例如：interface" value="" class="input-xlarge"></textarea>
                            </div>
                        </div>
                        <!-- 结束标识 -->
                        <div class="form-group" id="check_content_end_div" style="display:none">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>结束标识</strong></label>
                            <div class="col-sm-6">
                                 <textarea type="text" class="form-control" id="check_content_end" name="asset_mark"
                                           placeholder="例如：#或者!" value="" class="input-xlarge"></textarea>
                            </div>
                        </div>
                        <!-- 检查目标 -->
                        <div class="form-group" id="check_content_div">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>检查目标</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="check_content" disabled="disabled">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="1" name="check_content">配置文件</option>
                                    <option value="2" name="check_content">命令执行结果</option>
                                </select>
                            </div>
                        </div>
                        <!-- 命令 -->
                        <div class="form-group" id="command_div" style="display: none">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>命令</strong></label>
                            <div class="col-sm-6">
                                 <textarea type="text" class="form-control" id="command" name="command"
                                           placeholder="如 dispaly XXX" value="" class="input-xlarge"></textarea>
                            </div>
                        </div>
                        <!-- 设备厂商 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>设备厂商</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="support_firm" disabled="disabled">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="True" name="assets_type">配置文件</option>
                                    <option value="False" name="assets_type">命令执行结果</option>
                                </select>
                            </div>
                        </div>
                        <!-- 描述 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>描述</strong></label>
                            <div class="col-sm-6">
                                 <textarea type="text" class="form-control" id="rule_des" name="rule_des"
                                           placeholder="描述" value="" class="input-xlarge" disabled="disabled"></textarea>
                            </div>
                        </div>

                        <h5>匹配模式</h5>
                        <!-- 规则类型 -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>规则类型</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="rule_standard"
                                        onchange="javascript:rulestandard_select()">
                                    <option value="0" selected="selected" id="rule_standard">简单</option>
                                    <option value="1" id="rule_standard">高级</option>
                                </select>
                            </div>
                        </div>
                        <!-- 执行方法 -->
                        <div class="form-group" id="ExecMethod_div" style="display: none">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>执行方法</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="exec_method"
                                        onchange="javascript:execmethod_select()">
                                    <option selected="selected" value="0">检查</option>
                                    <option value="1">检查并提取</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    <form class="form-horizontal" role="form" id="rule_contentlist">
                        <!-- 规则关系 -->
                        <div class="form-group" id="RuleRelation_div" style="display: none">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>规则关系</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="rule_relation"
                                        onchange="javascript:type_select()">
                                    <option selected="selected" value="">请选择</option>
                                    <option value="0" name="type">AND</option>
                                    <option value="1" name="type">OR</option>
                                </select>
                            </div>
                        </div>
                        <!-- 匹配模式 -->
                        <div class="form-group" id="SplRuleCfg_div">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>匹配模式</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="spl_rule_cfg">

                                    <option selected="selected" value="">请选择</option>

                                    <option value="0" name="type">模糊匹配</option>

                                    <option value="1" name="type">模糊不匹配</option>

                                    <option value="2" name="type">精确匹配</option>

                                    <option value="2" name="type">精确不匹配</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="AdvRuleCfg_div" style="display: none">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>匹配模式</strong></label>
                            <div class="col-sm-6">
                                <select class="form-control center" id="adv_rule_cfg">

                                    <option selected="selected" value="">请选择</option>

                                    <option value="0" name="type">全部包含</option>

                                    <option value="1" name="type">部分包含</option>

                                    <option value="2" name="type">全部不包含</option>

                                    <option value="2" name="type">部分不包含</option>
                                </select>
                            </div>
                        </div>
                        <!-- 规则内容 -->
                        <div class="form-group " id="RuleContent_div">
                            <label class="col-sm-3 control-label no-padding-right"
                                   for="form-field-4"><font color='red'>* </font><strong>规则内容</strong></label>
                            <div class="col-sm-6">
                                 <textarea type="text" class="form-control" id="rule_content"
                                           placeholder="如 dispaly XXX" value="" class="input-xlarge"></textarea>
                            </div>
                            <div class="col-sm-3" id="addruleconent" style="display: none">
                                <button type="button" class="btn btn-default" onclick="addRuleContent()">增加规则
                                </button>
                            </div>
                        </div>

                    </form>
                    <!-- 规则列表 -->
                    <div class="form-group" id="RuleList_div" style="display: none">
                        <table width="100%" id="RuleList_table" class="table table-striped table-bordered table-hover">
                            <thead>
                            <tr>
                                <th class="text-center">规则关系</th>
                                <th class="text-center">匹配模式</th>
                                <th class="text-center">规则内容</th>
                                <th class="text-center">提取值得对比方式</th>
                                <th class="text-center">提取值得对比值</th>
                                <th class="text-center">删除</th>
                            </tr>
                            </thead>

                            <tbody>

                            </tbody>

                        </table>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                        </button>
                        <button type="button" class="btn btn-primary" onclick="addrule(this)">
                            添加
                        </button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>

    </div>
    <!-- /#wrapper -->
    <!--    弹窗开始样式 -->
    <script src="/static/dist/js/xcConfirm.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="/static/dist/css/xcConfirm.css"/>
    <!--   csrf -->
    <script src="/static/js/csrf.js"></script>

    <script type="text/javascript">

        function changepage(pageindex) {
            curpage = pageindex;
            search_go();
        }

        function RegexManageDetail(group_id) {
            $.ajax({
                dataType: "JSON",
                url: '/baseline/RegexRuleDetail/', //请求地址
                type: "POST",  //提交类似
                data: {'rule_id':group_id},
                success: function (response) {
                    $('#rule_name').text(response.rule['rule_name'])
                    $('#rule_severity').val(response.rule['rule_severity'])
                    $('#check_type').val(response.rule['check_type'])
                    $('#check_content').val(response.rule['check_content'])
                    $('#rule_des').text(response.rule['rule_des'])
                    $('#support_firm').val(response.rule['support_firm'])
                    $('#rule_standard').val(response.rule['rule_standard'])
                    if (response.rule['check_type'] ==1||response.rule['check_type'] ==2)
                    {
                        $('#check_content_start').text(response.rule['check_content_start'])
                        $('#check_content_end').text(response.rule['check_content_end'])
                        $('#check_content_start_div').show()
                        $('#check_content_end_div').show()
                    }
                    alert(response.rule['rule_standard'])
                    if(response.rule['rule_standard'] ==0){
                        $.each(response.rulecontent, function (i, item) {

                            $('#spl_rule_cfg').val(item['spl_rule_cfg'])
                            $('#rule_content').text(item['rule_content'])
                        })
                    }
                    $('#RegexManageDetail').modal('show')
                },
                error: function (response) {
                    alert('失败')
                    alert(response['rule'])
                }
            })
        }



        function removeself(obj) {
            $(obj).parent().remove();
            changepage(1);
        }


    </script>

    <script type="text/javascript">

        var selectState = false;

        function checkAllBox() {
            var qcheck = document.getElementsByName("ckbox");
            for (var i = 0; i < qcheck.length; i++) {
                var checkbox = qcheck[i];
                checkbox.checked = !selectState;
            }
            selectState = !selectState;
        }


        var downLoadFile = function (options) {
            var config = $.extend(true, {method: 'post'}, options);
            var $iframe = $('<iframe id="down-file-iframe"/>');
            var $form = $("<form target='down-file-iframe' method=" + config.method + " />");
            $form.attr('action', config.url);
            for (var key in config.data) {
                console.log('<input type="hidden" name="' + key + '" value="' + config.data[key] + '"/>');
                $form.append('<input type="hidden" name="' + key + '" value="' + config.data[key] + '"/>');
            }
            $form.append('{% csrf_token %}');
            $iframe.append($form);
            $(document.body).append($iframe);
            $form[0].submit();
            $iframe.remove();
        };

        function fcDumpsAssetsData(obj) {
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var serverId = [];
            var url = "/assets/batch/dumps/";
            $.each($("input[name='ckbox']:checkbox"), function () {
                if (this.checked) {
                    serverId.push($(this).val());
                }
            })
            if (serverId.length > 0) {
                var data = {
                    'assetsIds': serverId,
                };
                downLoadFile({ //调用下载方法
                    url: url, data: data
                });
            } else {
                window.wxc.xcConfirm("至少选择一个资产~", window.wxc.xcConfirm.typeEnum.error);
            }
            btnObj.removeAttr('disabled');
        }


        function updateAllAssets(obj, model) {
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var serverId = [];
            var qcheck = document.getElementsByName("ckbox");
            for (var i = 0; i < qcheck.length; i++) {
                if (qcheck[i].checked == true) {
                    serverId.push(qcheck[i].value);
                }
            }
            if (model == 'update') {
                var url = '/assets/batch/update/'
            } else if (model == 'delete') {
                var url = '/assets/batch/delete/'
            }
            if (serverId.length > 0) {
                $.ajax({
                    type: 'POST',
                    url: url,
                    dataType: "json",
                    data: {
                        'assetsIds': serverId,
                    },
                    success: function (response) {
                        var sip = '';
                        var fip = '';
                        var modal = '';
                        for (var i = 0; i < response['data']['success'].length; i++) {
                            sip += response['data']['success'][i] + '<br>'
                        }
                        for (var i = 0; i < response['data']['failed'].length; i++) {
                            fip += response['data']['failed'][i] + '<br>'
                        }
                        msg = '成功：' + '<br>' + sip + '<br>' + '失败：' + '<br>' + fip;
                        if (response['code'] == 200) {
                            window.wxc.xcConfirm(msg, window.wxc.xcConfirm.typeEnum.success);
                        } else {
                            window.wxc.xcConfirm(msg, window.wxc.xcConfirm.typeEnum.error);
                        }
                        btnObj.removeAttr('disabled');
                    },
                    error: function (response) {
                        btnObj.removeAttr('disabled');
                        window.wxc.xcConfirm("更新失败！", window.wxc.xcConfirm.typeEnum.error);
                    }
                });
            } else {
                window.wxc.xcConfirm("至少选择一个资产~", window.wxc.xcConfirm.typeEnum.error);
                btnObj.removeAttr('disabled');
            }
        }


        function format(dataList) {
            var trHtml = '';
            for (var i = 0; i < dataList.length; i++) {
                trHtml += '<tr><td>' + dataList[i]["name"] + ':</td>' + '<td>' + dataList[i]["value"] + '</td></tr>'
            }
            ;
            var vHtml = '<fieldset>' +
                '<legend>硬件信息</legend>' +
                '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                trHtml +
                '</table>'
            '</fieldset>';
            return vHtml;
        }


        //Flot Pie Chart
        $(function () {
            var data = [
                {% for ds in assetsNumber %}
                    {
                        {% if ds.assets_type == "server" %}
                            label: "服务器",
                        {% elif ds.assets_type == "vmser" %}
                            label: "虚拟机",
                        {% elif ds.assets_type == "switch" %}
                            label: "交换机",
                        {% elif ds.assets_type == "route" %}
                            label: "路由器",
                        {% elif ds.assets_type == "printer" %}
                            label: "打印机",
                        {% elif ds.assets_type == "scanner" %}
                            label: "扫描仪",
                        {% elif ds.assets_type == "firewall" %}
                            label: "防火墙",
                        {% elif ds.assets_type == "storage" %}
                            label: "存储设备",
                        {% elif ds.assets_type == "wifi" %}
                            label: "无线设备",
                        {% endif %}
                        data: {{ ds.dcount }}
                    },
                {% endfor %}
            ];
        });

        $(function () {
            Morris.Donut({
                element: 'asset_number',
                data: [
                    {% for ds in assetsNumber %}
                        {
                            {% if ds.assets_type == "server" %}
                                label: "服务器",
                            {% elif ds.assets_type == "switch" %}
                                label: "交换机",
                            {% elif ds.assets_type == "vmser" %}
                                label: "虚拟机",
                            {% elif ds.assets_type == "route" %}
                                label: "路由器",
                            {% elif ds.assets_type == "printer" %}
                                label: "打印机",
                            {% elif ds.assets_type == "scanner" %}
                                label: "扫描仪",
                            {% elif ds.assets_type == "firewall" %}
                                label: "防火墙",
                            {% elif ds.assets_type == "storage" %}
                                label: "存储设备",
                            {% elif ds.assets_type == "wifi" %}
                                label: "无线设备",
                            {% endif %}
                            value: {{ ds.dcount }}
                        },
                    {% endfor %}
                ],
                resize: true
            });

        });

        function deleteAssets(obj, id) {
            var txt = "是否确认删除？";
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var option = {
                title: "删除当前资产",
                btn: parseInt("0011", 2),
                onOk: function () {
                    $.ajax({
                        dataType: "JSON",
                        type: "POST",  //提交类似
                        url: '/assets_list/',
                        data: {'op': 'del', 'assets_id': id},
                        success: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除成功", window.wxc.xcConfirm.typeEnum.success);
                            location.reload('/assets_list/');
                        },
                        error: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除失败！", window.wxc.xcConfirm.typeEnum.error);
                        }
                    });
                },
                onCancel: function () {
                },
                onClose: function () {
                }
            }
            window.wxc.xcConfirm(txt, "custom", option);
        }


    </script>

{% endblock %}

