{% extends 'index.html' %}
{% block ace-content %}
<!-- ACE Editor -->   
<link href="/static/dist/css/bootstrap-multiselect.css" rel="stylesheet">
<script src="/static/dist/js/bootstrap-multiselect.js"></script>
<script type="text/javascript" src="/static/dist/js/bootstrap-notify.js"></script>
<link href="/static/dist/css/fileinput.css" media="all" rel="stylesheet" type="text/css" />
<script src="/static/dist/js/fileinput.js" type="text/javascript"></script>
<style type="text/css"> 
	td.details-control {
	    background: url('/static/img/details_open.png') no-repeat center center;
	    cursor: pointer;
	}
	tr.shown td.details-control {
	    background: url('/static/img/details_close.png') no-repeat center center;
	} 
</style>	
{% endblock %}
{% block page-content %}

<div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header"><i class="fa fa-file-pdf-o"></i> 配置文件管理</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <div class="row">
                <div class="col-lg-12" id="add_file_order" style="display:none;">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            	<i class="fa  fa-rss"></i> 配置文件上传
                        </div>
                        <div class="panel-body">

                            <div class="col-lg-6">
								<legend>
									<i class="fa  fa-paper-plane-o"></i> 目标设备选择
								</legend>
								<div class="form-group" >
									<label><font color='red'>* </font>设备名称</label>
									<select class="form-control" name="assets_name" id="assets_name">
										<option value="" name="server_model" selected="selected">选择设备</option>
                                        {% for asset in assets %}
                                            <option value="{{ asset.id }}" name="server_model">{{ asset.hostname }}</option>
                                        {% endfor %}
									</select>
								</div>
								<div class="form-group">
								 <label class="col-sm-2 control-label">上传文件</label>
								 <div class="col-sm-6">
								 	<input type="file" id="import_file" name="import_file"  placeholder="上传excel文件" required/>
								 </div>
							     </div>
                         </div>
							<!-- /.col-lg-6 (nested) -->
							<div class="hr hr32 hr-dotted"></div>
							 <div class="col-lg-6">

								<legend>
									<i class="fa  fa-paper-plane"></i> 文件工单
								</legend>
									{% csrf_token %}
									<div class="form-group">
	 									<label><font color='red'>* </font>配置文件描述<i class="fa fa-info-circle" data-toggle="tooltip" title="说明用途"></i></label>
										<textarea class="form-control" rows="3" id="conffile_detail"></textarea>
									</div>
									<lable id="addconffile"><button type="button" class="btn btn-default" onclick="addconffile(this)" >上传</button></lable>
									<button type="reset" class="btn btn-default">撤销</button>
                                </div>
							<!-- /.col-lg-6 (nested) -->
							 <div class="hr hr32 hr-dotted"></div>
							</div>
						</div>
					</div>
            </div>

            <div class="row">
                 <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            	<i class="fa  fa-paper-plane-o  "></i> 配置文件列表
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                        	<div>
                        		<button type="button" class="btn btn-xs btn-default" id="add_file_order_button"><i class="glyphicon glyphicon-plus"></i></button>
                        	</div>
							<table  width="100%" class="table table-striped table-bordered table-hover dataTable no-footer" id="taskTableList">	
						        <thead>
						            <tr>
						                <th class="text-center">详细</th>
						                <th class="text-center">ID</th>
						                <th class="text-center">设备名称</th>
						                <th class="text-center">文件名称</th>
						                <th class="text-center">描述</th>
						                <th class="text-center">上传时间</th>
										<th class="text-center">操作</th>
						            </tr>
						        </thead>
						        <tfoot>
						            <tr>
						                <th class="text-center">详细</th>
						                <th class="text-center">ID</th>
						                <th class="text-center">设备名称</th>
						                <th class="text-center">文件名称</th>
						                <th class="text-center">描述</th>
						                <th class="text-center">上传时间</th>
										<th class="text-center">操作</th>
						            </tr>
						        </tfoot>													
		                                <tbody>

	                                    </tbody>
	                       	</table>
										{% if uploadList %}
											<ul class="pagination">
											        {% if uploadList.has_previous %}
											            <li><a href="/order/file/download/list/{{ projectList.previous_page_number }}/">&laquo;</a></li>
											        {% endif %}
											        {% for page in uploadList.paginator.page_range %}
											        	{% if uploadList.number == page %}
											        		<li class="disabled"><a href="/order/file/download/list/{{page}}/">{{page}}</a></li>
											        	{% else %}
											        		<li><a href="/order/file/download/list/{{page}}/">{{page}}</a></li>
											        	{% endif %}
											        {% endfor %}
											        {% if uploadList.has_next %}
											            <li><a href="/order/file/download/list/{{ uploadList.next_page_number }}/">&raquo;</a></li>
											        {% endif %}
											</ul>
                     		            {% endif %}		                       	
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
            </div>                    
</div>




<script type="text/javascript"> 
$(function(){
    $('#add_file_order_button').click(function(){//点击a标签
        if($('#add_file_order').is(':hidden')){
        	$('#add_file_order').show();
        }
        else{
        	$('#add_file_order').hide();
        }
    })
})
function addconffile(obj){
		var btnObj = $(obj);
		btnObj.attr('disabled',true);
		var serverId = [];
	    var url = "/conffile/list/";
	    alert(document.getElementById("assets_name").value)
        alert(document.getElementById("import_file").value)
        alert(document.getElementById("conffile_detail").value)
		}

$(document).ready(function() {
    $('#ansible_server').multiselect({
        enableClickableOptGroups: true,
        enableCollapsibleOptGroups: true,
        includeSelectAllOption: true,
       	enableFiltering: true,            
    });
});




function oBtAnsibleServerl(){
	   var obj = document.getElementById("server_model"); 
	   var index = obj.selectedIndex;
	   var value = obj.options[index].value; 
	   if (value=="group"){
		   document.getElementById("group_server").style.display = "";
		   document.getElementById("custom_server").style.display = "none";
		   document.getElementById("project_server").style.display = "none";
	   }
	   else if (value=="custom"){
		   document.getElementById("group_server").style.display = "none";
		   document.getElementById("custom_server").style.display = "";
		   document.getElementById("project_server").style.display = "none";
	   }
	   else if (value=="service"){
		   document.getElementById("group_server").style.display = "none";
		   document.getElementById("custom_server").style.display = "none";
		   document.getElementById("project_server").style.display = "";
	   }	   
	   else {
		   document.getElementById("group_server").style.display = "none";
		   document.getElementById("custom_server").style.display = "none"; 
		   document.getElementById("project_server").style.display = "none";
	   }	
}


function oBtProjectSelect(){
	   $('#ansible_service').removeAttr("disabled");
	   var obj = document.getElementById("ansible_project"); 
	   var index = obj.selectedIndex;
	   var projectId = obj.options[index].value; 
	   if ( projectId > 0){	 
			$.ajax({
				dataType: "JSON",
				url:'/api/project/'+ projectId + '/', //请求地址
				type:"GET",  //提交类似
				success:function(response){
					var binlogHtml = '<select class="form-control" name="ansible_service" id="ansible_service" onchange="javascript:oBtServiceSelect();" required><option selected="selected" name="ansible_service" value="">请选择业务类型</option>'
					var selectHtml = '';
					for (var i=0; i <response["service_assets"].length; i++){
						 selectHtml += '<option name="ansible_service" value="'+ response["service_assets"][i]["id"] +'">' + response["service_assets"][i]["service_name"] + '</option>' 
					};                        
					binlogHtml =  binlogHtml + selectHtml + '</select>';
					document.getElementById("ansible_service").innerHTML= binlogHtml;	
						
				},
			});	
	   }
	   else{
		   $('#ansible_service').attr("disabled",true);
	   }

}

function oBtServiceSelect(model,ids){
	   var obj = document.getElementById(ids); 
	   var index = obj.selectedIndex;
	   var sId = obj.options[index].value; 
	   if ( sId  > 0){	 
			$.ajax({
				dataType: "JSON",
				url:'/assets_server/', //请求地址
				type:"POST",  //提交类似
				data:{
					"query":model,
					"id":sId
				},
				success:function(response){
					var sHtml = '';
					for (var i=0; i <response["data"].length; i++){
						sHtml += '<br>' + response["data"][i]["ip"]  
					};  
					if ( sHtml.length > 0){
						$.notify({
							title: "<strong>发现主机:</strong>",
							message: sHtml
						},
						{
							type: 'info'
						});	
						$('#run_ansible_model').removeAttr("disabled");
					}
					else {
						$.notify({
							title: "<strong>Ops：</strong>",
							message: "该条件下未发现主机资源~"
						},
						{
							type: 'danger'
						});
						$('#run_ansible_model').attr("disabled",true);
					}
				
						
				},
			});	
	   }
	   else{
		   $('#server option:selected').empty();
		   $('#server').attr("disabled",true);
	   }

}




function auditSqlOrder(obj,op) {	
	var btnObj = $(obj);
	var required = ["dest_path","order_executor","dest_path","server_model","order_content"];
    var formData = new FormData();	
	btnObj.attr('disabled',true);
	var form = document.getElementById('audit_filedownload_order');
		for (var i = 0; i < form.length; ++i) {
			var name = form[i].name;
			var value = form[i].value;	
			idx = $.inArray(name, required);						
			if (idx >= 0 && value.length == 0){
				window.wxc.xcConfirm("请注意必填项不能为空~", window.wxc.xcConfirm.typeEnum.error);
				btnObj.removeAttr('disabled');
				return false;
			};					
		};
		var serverList = new Array();
		$("#ansible_server option:selected").each(function () {
			serverList.push($(this).val())
		})		
	    formData.append('order_subject',$('#order_subject').val());
	    formData.append('dest_path',$('#dest_path').val());
	    formData.append('order_content',$('#order_content').val());
	    formData.append('server_model',$('#server_model option:selected').val());
	    formData.append('service',$('#ansible_service option:selected').val());
	    formData.append('group',$('#ansible_group option:selected').val());
	    formData.append('server',serverList);
	    formData.append('order_executor',$('#order_executor option:selected').val());
		$.ajax({
/* 				dataType: "JSON", */
			url:'/order/file/download/apply/', //请求地址
			type:"POST",  //提交类似
		    processData: false,
		    contentType: false,				
			data:formData,  //提交参数
			success:function(response){
				btnObj.removeAttr('disabled');				
				if (response["code"] == 200){
					window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
				}
				else {
					window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
				};
			},
	    	error:function(response){
	    		btnObj.removeAttr('disabled');
	    		window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
	    	}
		});	
	}
	
function format ( data ) {
	var serHtml = '';
	serList = JSON.parse(data["dest_server"]);
	for  (var i=0; i <serList.length; i++){
		serHtml += serList[i] + ',';
	}
    var trHtml = '<tr><td>目标目录:</td><td>'+ data["dest_path"]  + '</td><td>目标服务器:</td><td>'+ serHtml.substring(0,serHtml.length-1) +'</td></tr>'	;
    var vHtml = '<fieldset>' +
    			'<legend>文件下载信息</legend>' +
    				'<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;word-break:break-all; word-wrap:break-all;">'+
    				  trHtml  +
    				'</table>'
			'</fieldset>'; 				
    return vHtml;
}	
	 

$(document).ready(function() {
	    var table = $('#taskTableList').DataTable( {
/* 	        "ajax": "../ajax/data/objects.txt", */
	        "columns": [
	            {
	                "className":      'details-control',
	                "orderable":      false,
	                "data":           null,
	                "defaultContent": ''
	            },
	            { "data": "id" },
	            { "data": "用途描述" },
	            { "data": "文件路径" },
	            { "data": "状态" },
	            { "data": "申请时间" },
	            { "data": "操作" }       
	        ],
	        "order": [[6, 'asc']]
	    } );    
	    
	    // Add event listener for opening and closing details
	    $('#taskTableList tbody').on('click', 'td.details-control', function () {
	    	var dataList = [];
	        var tr = $(this).closest('tr');
	        var row = table.row( tr );
	        dbId = row.data()["id"];
	        $.ajax({
	            url : "/api/file/download/"+dbId+"/",
	            type : "GET",
	            async : false,
	            data : {"id":dbId},
	            dataType : "json",
	            success : function(result) {
	            	dataList = result;
	            }
	        });	        
/* 	    	console.log(dataList); */
	        if ( row.child.isShown() ) {
	            // This row is already open - close it
	            row.child.hide();
	            tr.removeClass('shown');
	        }
	        else {
	            // Open this row
	            row.child( format(dataList) ).show();
	            tr.addClass('shown');
	        }
	    } );
	} );	

	
		
	
</script>
{% endblock %}
